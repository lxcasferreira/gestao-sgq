<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Gestão de Qualidade - UOB</title>
    <link rel="shortcut icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSw8KaHwj_yzSUPmo-IzqVxEnKP2mCKq8_1Jg&s" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --cor-primaria: #00943A;
  --cor-secundaria: #006428;
  --cor-terciaria: #004d1f;
  --cor-sucesso: #28a745;
  --cor-aviso: #ffc107;
  --cor-erro: #dc3545;
  --cor-info: #17a2b8;
  --cor-texto: #2c3e50;
  --cor-texto-claro: #6c757d;
  --cor-fundo: #f8f9fa;
  --cor-card: #ffffff;
  --cor-borda: #dee2e6;
  --sombra-card: 0 2px 8px rgba(0,0,0,0.1);
  --sombra-hover: 0 4px 16px rgba(0,0,0,0.15);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Montserrat', sans-serif;
    background: var(--cor-fundo);
    color: var(--cor-texto);
    min-height: 100vh;
}

/* ============== HEADER ============== */
.header-principal {
    background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-secundaria) 100%);
    color: white;
    padding: 20px 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.header-conteudo {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo-titulo {
    display: flex;
    align-items: center;
    gap: 15px;
}

.logo-icon {
    width: 50px;
    height: 50px;
    background: white;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: var(--cor-primaria);
    font-weight: 700;
}

.titulo-sistema {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -0.5px;
}

.subtitulo-sistema {
    font-size: 13px;
    font-weight: 400;
    opacity: 0.9;
    margin-top: 2px;
}

.header-acoes {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 12px 24px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-family: 'Montserrat', sans-serif;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.btn-primario {
    background: white;
    color: var(--cor-primaria);
}

.btn-secundario {
    background: #6c757d;
    color: white;
    border: none;
}

.btn-sucesso {
    background: var(--cor-sucesso);
    color: white;
}

.btn-aviso {
    background: var(--cor-aviso);
    color: var(--cor-texto);
}

.btn-erro {
    background: var(--cor-erro);
    color: white;
}

.btn-small {
    padding: 8px 16px;
    font-size: 12px;
}

/* ============== CONTAINER PRINCIPAL ============== */
.container-principal {
    max-width: 1400px;
    margin: 30px auto;
    padding: 0 20px;
}

/* ============== TABS ============== */
.tabs-container {
    background: var(--cor-card);
    border-radius: 12px;
    box-shadow: var(--sombra-card);
    overflow: hidden;
}

.tabs-header {
    display: flex;
    border-bottom: 2px solid var(--cor-borda);
    background: #f8f9fa;
}

.tab-btn {
    flex: 1;
    padding: 18px 24px;
    background: transparent;
    border: none;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--cor-texto-claro);
    font-family: 'Montserrat', sans-serif;
    position: relative;
}

.tab-btn:hover {
    background: rgba(0, 148, 58, 0.05);
    color: var(--cor-primaria);
}

.tab-btn.active {
    background: white;
    color: var(--cor-primaria);
}

.tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--cor-primaria) 0%, var(--cor-secundaria) 100%);
}

.tab-conteudo {
    padding: 30px;
    display: none;
}

.tab-conteudo.active {
    display: block;
}

/* ============== SEÇÕES ============== */
.secao {
    margin-bottom: 30px;
}

.secao-titulo {
    font-size: 18px;
    font-weight: 700;
    color: var(--cor-primaria);
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 3px solid var(--cor-primaria);
    display: flex;
    align-items: center;
    gap: 10px;
}

.secao-titulo i {
    font-size: 20px;
}

/* ============== GRID DE CAMPOS ============== */
.grid-campos {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.campo-grupo {
    position: relative;
}

.campo-label {
    font-size: 13px;
    font-weight: 600;
    color: var(--cor-texto);
    display: block;
    margin-bottom: 8px;
}

.campo-input,
.campo-select {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid var(--cor-borda);
    border-radius: 8px;
    font-size: 14px;
    font-family: 'Montserrat', sans-serif;
    transition: all 0.3s ease;
}

.campo-input:focus,
.campo-select:focus {
    outline: none;
    border-color: var(--cor-primaria);
    box-shadow: 0 0 0 3px rgba(0, 148, 58, 0.1);
}

.campo-input.erro {
    border-color: var(--cor-erro);
    background-color: #fff5f5;
}

.mensagem-erro {
    color: var(--cor-erro);
    font-size: 12px;
    margin-top: 5px;
    display: none;
}

/* ============== CONFERENTES ============== */
.conferentes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
}

.conferente-checkbox {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: var(--cor-fundo);
    border: 2px solid var(--cor-borda);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.conferente-checkbox:hover {
    background: white;
    border-color: var(--cor-primaria);
}

.conferente-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--cor-primaria);
}

.conferente-checkbox span {
    font-weight: 500;
    font-size: 14px;
}

/* ============== TEMPOS ============== */
.tempo-campo {
    display: flex;
    gap: 8px;
    align-items: flex-end;
}

.tempo-input {
    flex: 1;
}

.btn-tempo {
    width: 44px;
    height: 44px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

/* ============== CARTÕES DE OPERAÇÃO ============== */
.cartao-operacao {
    background: var(--cor-card);
    border: 2px solid var(--cor-borda);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: var(--sombra-card);
    transition: all 0.3s ease;
}

.cartao-operacao:hover {
    box-shadow: var(--sombra-hover);
    transform: translateY(-2px);
}

.cartao-operacao.alerta-sla {
    border-left: 5px solid var(--cor-erro);
    background: linear-gradient(to right, #fff5f5 0%, white 100%);
}

.cartao-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--cor-fundo);
}

.cartao-titulo {
    font-size: 20px;
    font-weight: 700;
    color: var(--cor-primaria);
}

.cartao-data {
    font-size: 13px;
    color: var(--cor-texto-claro);
    margin-top: 5px;
}

.cartao-badges {
    display: flex;
    gap: 10px;
    align-items: center;
}

.badge {
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 700;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-concluido {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.badge-andamento {
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
    color: white;
}

.badge-sla {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    animation: pulse-badge 2s infinite;
}

@keyframes pulse-badge {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.cartao-body {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.info-item {
    font-size: 13px;
}

.info-item-label {
    display: block;
    color: var(--cor-texto-claro);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 5px;
    letter-spacing: 0.5px;
}

.info-item-valor {
    font-weight: 600;
    color: var(--cor-texto);
}

.tempo-info {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 15px;
    padding: 12px;
    background: var(--cor-fundo);
    border-radius: 8px;
    font-size: 14px;
}

.indicador-live {
    width: 10px;
    height: 10px;
    background: var(--cor-erro);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.1); }
}

.cartao-acoes {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 2px solid var(--cor-fundo);
    display: flex;
    gap: 10px;
}

/* ============== BUSCA E FILTROS ============== */
.barra-busca-filtros {
    background: var(--cor-card);
    border: 2px solid var(--cor-borda);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 25px;
}

.campo-busca {
    width: 100%;
    padding: 14px 20px 14px 50px;
    border: 2px solid var(--cor-borda);
    border-radius: 10px;
    font-size: 15px;
    margin-bottom: 20px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2300943A' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 18px center;
    font-family: 'Montserrat', sans-serif;
}

.campo-busca:focus {
    border-color: var(--cor-primaria);
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 148, 58, 0.1);
}

.filtros-botoes {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.btn-filtro {
    padding: 10px 20px;
    border: 2px solid var(--cor-borda);
    background: white;
    border-radius: 25px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s ease;
    font-family: 'Montserrat', sans-serif;
}

.btn-filtro:hover {
    background: var(--cor-fundo);
    border-color: var(--cor-primaria);
    color: var(--cor-primaria);
}

.btn-filtro.active {
    background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-secundaria) 100%);
    color: white;
    border-color: var(--cor-primaria);
}

/* ============== ESTATÍSTICAS ============== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, var(--cor-card) 0%, #f8f9fa 100%);
    border: 2px solid var(--cor-borda);
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--sombra-hover);
    border-color: var(--cor-primaria);
}

.stat-card-titulo {
    font-size: 13px;
    color: var(--cor-texto-claro);
    margin-bottom: 12px;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.stat-card-valor {
    font-size: 36px;
    font-weight: 800;
    color: var(--cor-primaria);
    margin-bottom: 8px;
}

.stat-card-subtitulo {
    font-size: 12px;
    color: var(--cor-texto-claro);
}

/* ============== TOAST ============== */
.toast {
    position: fixed;
    top: 30px;
    right: 30px;
    background: var(--cor-sucesso);
    color: white;
    padding: 18px 28px;
    border-radius: 10px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    z-index: 9999;
    animation: slideIn 0.4s ease-out;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
}

.toast.erro {
    background: var(--cor-erro);
}

.toast.aviso {
    background: var(--cor-aviso);
    color: var(--cor-texto);
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* ============== AUTOCOMPLETE ============== */
.input-group {
    position: relative;
}

.autocomplete-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid var(--cor-borda);
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.autocomplete-item {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--cor-fundo);
    transition: all 0.2s ease;
}

.autocomplete-item:hover {
    background: var(--cor-fundo);
    color: var(--cor-primaria);
}

.add-new-option {
    padding: 12px 15px;
    background: #e8f5e9;
    color: var(--cor-sucesso);
    font-weight: 600;
    cursor: pointer;
    border-top: 2px solid var(--cor-sucesso);
}

.add-new-option:hover {
    background: #c8e6c9;
}

/* ============== RESPONSIVO ============== */
@media(max-width: 768px) {
    .header-conteudo {
        flex-direction: column;
        gap: 15px;
    }
    
    .header-acoes {
        width: 100%;
        justify-content: center;
    }
    
    .tabs-header {
        flex-direction: column;
    }
    
    .grid-campos {
        grid-template-columns: 1fr;
    }
    
    .conferentes-grid {
        grid-template-columns: 1fr;
    }
}

/* ============== RODAPÉ ============== */
.rodape {
    background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-secundaria) 100%);
    padding: 15px 0;
    text-align: center;
    color: white;
    margin-top: 50px;
}

.rodape-faixa {
    height: 5px;
    background: linear-gradient(90deg, 
        var(--cor-primaria) 0%, 
        var(--cor-secundaria) 50%, 
        var(--cor-terciaria) 100%);
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header-principal">
    <div class="header-conteudo">
        <div class="logo-titulo">
            <div class="logo-icon">
                <i class="fas fa-truck-moving"></i>
            </div>
            <div>
                <div class="titulo-sistema">G2L Logística</div>
                <div class="subtitulo-sistema">Sistema de Gestão de Qualidade</div>
            </div>
        </div>
        <div class="header-acoes">
            <button class="btn btn-secundario" onclick="exportarCSV()" style="background:#6c757d;color:white;">
                <i class="fas fa-file-csv"></i> Exportar CSV
            </button>
            <button class="btn btn-secundario" onclick="buscarDadosFirebase()" style="background:#6c757d;color:white;">
                <i class="fas fa-cloud-download-alt"></i> Sincronizar
            </button>
        </div>
    </div>
</div>

<!-- CONTAINER PRINCIPAL -->
<div class="container-principal">

    <!-- TABS -->
    <div class="tabs-container">
        <div class="tabs-header">
            <button class="tab-btn active" onclick="mudarTab('nova')">
                <i class="fas fa-plus-circle"></i> Nova Operação
            </button>
            <button class="tab-btn" onclick="mudarTab('consulta')">
                <i class="fas fa-search"></i> Consulta
            </button>
            <button class="tab-btn" onclick="mudarTab('estatisticas')">
                <i class="fas fa-chart-bar"></i> Estatísticas
            </button>
        </div>

        <!-- TAB: NOVA OPERAÇÃO -->
        <div id="nova" class="tab-conteudo active">
            
            <!-- IDENTIFICAÇÃO -->
            <div class="secao">
                <h3 class="secao-titulo">
                    <i class="fas fa-id-card"></i> Identificação
                </h3>
                <div class="grid-campos">
                    <div class="campo-grupo">
                        <label class="campo-label">DT</label>
                        <input type="text" id="dt" class="campo-input" placeholder="Número DT">
                    </div>
                    
                    <div class="campo-grupo input-group">
                        <label class="campo-label">Placa</label>
                        <input type="text" id="placa" class="campo-input" autocomplete="off" placeholder="ABC-1234">
                        <div id="placa-autocomplete" class="autocomplete-list"></div>
                        <span class="mensagem-erro" id="placa-error">Formato de placa inválido</span>
                    </div>

                    <div class="campo-grupo">
                        <label class="campo-label">BOX</label>
                        <select id="box" class="campo-select">
                            <option value="">Selecione...</option>
                            <option value="BOX 1">BOX 1</option>
                            <option value="BOX 2">BOX 2</option>
                            <option value="BOX 3">BOX 3</option>
                            <option value="BOX 4">BOX 4</option>
                            <option value="BOX 5">BOX 5</option>
                        </select>
                    </div>
                    
                    <div class="campo-grupo">
                        <label class="campo-label">Tipo de Veículo</label>
                        <select id="tipoVeiculo" class="campo-select">
                            <option value="">Selecione...</option>
                            <option value="SIDER / BITRUCK">SIDER / BITRUCK</option>
                            <option value="SIDER / RODOTREM">SIDER / RODOTREM</option>
                            <option value="GRADE BAIXA / RODOTREM">GRADE BAIXA / RODOTREM</option>
                            <option value="GRANELEIRO / RODOTREM">GRANELEIRO / RODOTREM</option>
                            <option value="GRADE BAIXA / VANDERLEIA">GRADE BAIXA / VANDERLEIA</option>
                            <option value="GRANELEIRO / VANDERLEIA">GRANELEIRO / VANDERLEIA</option>
                            <option value="GRADE BAIXA / QUARTO EIXO">GRADE BAIXA / QUARTO EIXO</option>
                            <option value="GRANELEIRO / QUARTO EIXO">GRANELEIRO / QUARTO EIXO</option>
                            <option value="GRADE BAIXA / TRUCK">GRADE BAIXA / TRUCK</option>
                            <option value="GRADE BAIXA / BITREM">GRADE BAIXA / BITREM</option>
                            <option value="GRANELEIRO / BITREM">GRANELEIRO / BITREM</option>
                            <option value="COLMEIA">COLMEIA</option>
                            <option value="PRANCHA / QUARTO EIXO">PRANCHA / QUARTO EIXO</option>
                        </select>
                    </div>

                    <div class="campo-grupo">
                        <label class="campo-label">Material</label>
                        <select id="material" class="campo-select">
                            <option value="">Selecione...</option>
                            <option value="PERFIL">PERFIL</option>
                            <option value="FIO MAQUINA">FIO MAQUINA</option>
                            <option value="CHAPA GROSSA">CHAPA GROSSA</option>
                            <option value="BOBINA BQ">BOBINA BQ</option>
                            <option value="TARUGO">TARUGO</option>
                        </select>
                    </div>

                    <div class="campo-grupo">
                        <label class="campo-label">Equipe</label>
                        <select id="configuracao" class="campo-select">
                            <option value="">Selecione...</option>
                            <option value="DUPLA">DUPLA</option>
                            <option value="TRIO">TRIO</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- CONFERENTES -->
            <div class="secao">
                <h3 class="secao-titulo">
                    <i class="fas fa-users"></i> Conferentes
                </h3>
                <div class="conferentes-grid">
                    <label class="conferente-checkbox">
                        <input type="checkbox" name="conferente" value="Fernando">
                        <span>Fernando</span>
                    </label>
                    <label class="conferente-checkbox">
                        <input type="checkbox" name="conferente" value="Vinicius">
                        <span>Vinicius</span>
                    </label>
                    <label class="conferente-checkbox">
                        <input type="checkbox" name="conferente" value="Reinaldo">
                        <span>Reinaldo</span>
                    </label>
                    <label class="conferente-checkbox">
                        <input type="checkbox" name="conferente" value="Charles">
                        <span>Charles</span>
                    </label>
                    <label class="conferente-checkbox">
                        <input type="checkbox" name="conferente" value="Josiane">
                        <span>Josiane</span>
                    </label>
                    <label class="conferente-checkbox">
                        <input type="checkbox" name="conferente" value="Giovanni">
                        <span>Giovanni</span>
                    </label>
                </div>
            </div>

            <!-- TEMPOS -->
            <div class="secao">
                <h3 class="secao-titulo">
                    <i class="fas fa-clock"></i> Controle de Tempos
                </h3>
                <div class="grid-campos">
                    <div class="campo-grupo">
                        <label class="campo-label">Entrada</label>
                        <div class="tempo-campo">
                            <input type="text" id="entrada" class="campo-input tempo-input" readonly>
                            <button class="btn btn-sucesso btn-tempo" onclick="marcarTempo('entrada')">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    </div>
                    <div class="campo-grupo">
                        <label class="campo-label">Checklist Inicial</label>
                        <div class="tempo-campo">
                            <input type="text" id="checki" class="campo-input tempo-input" readonly>
                            <button class="btn btn-sucesso btn-tempo" onclick="marcarTempo('checki')">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    </div>
                    <div class="campo-grupo">
                        <label class="campo-label">Preparação</label>
                        <div class="tempo-campo">
                            <input type="text" id="prep" class="campo-input tempo-input" readonly>
                            <button class="btn btn-sucesso btn-tempo" onclick="marcarTempo('prep')">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    </div>
                    <div class="campo-grupo">
                        <label class="campo-label">Amarração</label>
                        <div class="tempo-campo">
                            <input type="text" id="amar" class="campo-input tempo-input" readonly>
                            <button class="btn btn-sucesso btn-tempo" onclick="marcarTempo('amar')">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    </div>
                    <div class="campo-grupo">
                        <label class="campo-label">Checklist Final</label>
                        <div class="tempo-campo">
                            <input type="text" id="checkf" class="campo-input tempo-input" readonly>
                            <button class="btn btn-sucesso btn-tempo" onclick="marcarTempo('checkf')">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    </div>
                    <div class="campo-grupo">
                        <label class="campo-label">Saída</label>
                        <div class="tempo-campo">
                            <input type="text" id="saida" class="campo-input tempo-input" readonly>
                            <button class="btn btn-sucesso btn-tempo" onclick="marcarTempo('saida')">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AÇÕES -->
            <div style="display:flex;gap:15px;margin-top:30px;flex-wrap:wrap;">
                <button class="btn btn-secundario" onclick="salvar()" style="background:#6c757d;color:white;">
                    <i class="fas fa-save"></i> Salvar Operação
                </button>
                <button class="btn btn-secundario" onclick="limparFormulario()" style="background:#6c757d;color:white;">
                    <i class="fas fa-eraser"></i> Limpar
                </button>
            </div>
        </div>

        <!-- TAB: CONSULTA -->
        <div id="consulta" class="tab-conteudo">
            <div class="barra-busca-filtros">
                <input type="text" id="search-input" class="campo-busca" placeholder="Buscar por placa, DT, data...">
                
                <div class="filtros-botoes">
                    <button class="btn-filtro active" onclick="filtrarStatus('todas')">
                        <i class="fas fa-list"></i> Todas
                    </button>
                    <button class="btn-filtro" onclick="filtrarStatus('concluida')">
                        <i class="fas fa-check-circle"></i> Concluídas
                    </button>
                    <button class="btn-filtro" onclick="filtrarStatus('andamento')">
                        <i class="fas fa-hourglass-half"></i> Em Andamento
                    </button>
                </div>
            </div>
            
            <div id="lista-operacoes"></div>
        </div>

        <!-- TAB: ESTATÍSTICAS -->
        <div id="estatisticas" class="tab-conteudo">
            <h3 class="secao-titulo">
                <i class="fas fa-chart-line"></i> Análise de Desempenho
            </h3>
            <div id="stats-content"></div>
        </div>

    </div>
</div>

<!-- RODAPÉ -->
<div class="rodape">
    <div class="rodape-faixa"></div>
    <div style="padding: 20px;">
        <p style="margin: 0; font-weight: 600;">© 2026 G2L Logística - Sistema de Gestão de Qualidade</p>
        <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">Desenvolvido por lucas.ferreira@logisticag2l.com.br <i class="" style="color: #ff6b6b;"></i></p>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    getDocs,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "",
    authDomain: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: "",
    measurementId: ""
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.buscarDadosFirebase = async function(){
    try{
      const snapshot = await getDocs(collection(db, "operacoes"));
      const dadosNuvem = [];

      snapshot.forEach(doc=>{
        dadosNuvem.push({
          id: doc.id,
          ...doc.data()
        });
      });

      console.log('Dados carregados:', dadosNuvem);
      atualizarSistemaComDados(dadosNuvem);

    }catch(err){
      console.error(err);
      alert('Erro ao buscar dados do banco');
    }
  }

  window.db = db;
  window.fbDoc = doc;
  window.fbSetDoc = setDoc;
  window.fbGetDocs = getDocs;
  window.fbCollection = collection;
  window.fbServerTimestamp = serverTimestamp;

  function gerarIdPorDT(dt){
    return String(dt || '')
      .trim()
      .replace(/\s+/g, '_')
      .replace(/[^\w\-]/g, '');
  }

  window.gerarIdPorDT = gerarIdPorDT;

  window.atualizarSistemaComDados = function(novosDados){
    dados = novosDados;
    localStorage.setItem('g2l', JSON.stringify(dados));
    listar();

    if(document.getElementById('estatisticas')?.classList.contains('active')){
      criarDashboardCorporativo();
      gerarDashboardCorporativo();
    }

    mostrarToast('Sistema sincronizado com a nuvem', 'success');
  };
</script>

<script>
let dados = JSON.parse(localStorage.getItem('g2l')||'[]');
let veiculos = JSON.parse(localStorage.getItem('g2l_veiculos')||'[]');
let motoristas = JSON.parse(localStorage.getItem('g2l_motoristas')||'[]');
let timers = {};
let startTimes = {};
let elapsedSeconds = {};
let paused = {};
let filtroAtual = 'todas';
let termoBusca = '';
let updateInterval = null;
let operacaoAtualId = null;

// Salvar estado dos timers
function salvarEstadoTimers(){
  const estado = {
    startTimes: startTimes,
    elapsedSeconds: elapsedSeconds,
    paused: paused,
    operacaoAtualId: operacaoAtualId
  };
  localStorage.setItem('g2l_timer_state', JSON.stringify(estado));
}

// Restaurar estado dos timers
function restaurarEstadoTimers(){
  const estado = JSON.parse(localStorage.getItem('g2l_timer_state')||'{}');
  if(!estado.startTimes) return;
  
  startTimes = estado.startTimes;
  elapsedSeconds = estado.elapsedSeconds || {};
  paused = estado.paused || {};
  operacaoAtualId = estado.operacaoAtualId;
  
  Object.keys(startTimes).forEach(campo => {
    const input = document.getElementById(campo);
    if(!input) return;
    
    if(!paused[campo]){
      const agora = Date.now();
      elapsedSeconds[campo] = Math.floor((agora - startTimes[campo]) / 1000);
    }
    
    const seg = elapsedSeconds[campo] || 0;
    const h = String(Math.floor(seg/3600)).padStart(2,'0');
    const m = String(Math.floor((seg%3600)/60)).padStart(2,'0');
    const s = String(seg%60).padStart(2,'0');
    input.value = `${h}:${m}:${s}`;
    
    if(!paused[campo]){
      iniciarTimer(campo);
      criarBotaoPausa(campo);
    } else {
      criarBotaoPausa(campo);
      const btn = document.getElementById(`pause-${campo}`);
      if(btn) btn.innerHTML = '<i class="fas fa-play"></i>';
    }
  });
}

// Sistema de autocomplete
function setupAutocomplete(inputId, listId, dataArray) {
  const input = document.getElementById(inputId);
  const list = document.getElementById(listId);
  
  if(!input || !list) return;
  
  input.addEventListener('input', function() {
    const value = this.value.toLowerCase();
    list.innerHTML = '';
    
    if(value.length < 1) {
      list.style.display = 'none';
      return;
    }
    
    const filtered = dataArray.filter(item => 
      item.toLowerCase().includes(value)
    );
    
    if(filtered.length > 0 || value.length > 0) {
      list.style.display = 'block';
      
      filtered.forEach(item => {
        const div = document.createElement('div');
        div.className = 'autocomplete-item';
        div.textContent = item;
        div.onclick = () => {
          input.value = item;
          list.style.display = 'none';
        };
        list.appendChild(div);
      });
      
      if(!filtered.includes(value.toUpperCase()) && value.length > 0) {
        const addNew = document.createElement('div');
        addNew.className = 'add-new-option';
        addNew.innerHTML = `<i class="fas fa-plus-circle"></i> Adicionar "${value.toUpperCase()}"`;
        addNew.onclick = () => {
          const newValue = value.toUpperCase();
          input.value = newValue;
          if(inputId === 'placa') {
            if(!veiculos.includes(newValue)) {
              veiculos.push(newValue);
              localStorage.setItem('g2l_veiculos', JSON.stringify(veiculos));
            }
          }
          list.style.display = 'none';
          mostrarToast('Novo item adicionado à lista!', 'success');
        };
        list.appendChild(addNew);
      }
    } else {
      list.style.display = 'none';
    }
  });
  
  document.addEventListener('click', function(e) {
    if(e.target !== input) {
      list.style.display = 'none';
    }
  });
}

function carregarListasExistentes() {
  dados.forEach(op => {
    if(op.placa && !veiculos.includes(op.placa)) {
      veiculos.push(op.placa);
    }
  });
  localStorage.setItem('g2l_veiculos', JSON.stringify(veiculos));
}

async function backupFirebase(operacao){
  try{
    if(!operacao.dt){
      console.warn("Operação sem DT");
      return;
    }

    const id = `${gerarIdPorDT(operacao.dt)}_${operacao.placa}`;

    await fbSetDoc(
      fbDoc(db, "operacoes", id),
      {
        ...operacao,
        backupEm: fbServerTimestamp()
      }
    );

    console.log("Backup Firebase OK com ID:", id);
  }catch(err){
    console.error("Erro no backup Firebase", err);
  }
}

function valorParaSegundos(campo){
  const v = document.getElementById(campo).value;
  if(!v) return 0;
  const p = v.split(':').map(Number);
  return (p[0]||0)*3600 + (p[1]||0)*60 + (p[2]||0);
}

const ordemEtapas = ['entrada', 'checki', 'amar', 'checkf', 'saida'];

function validarPlaca(placa){
  const formatoAntigo = /^[A-Z]{3}-?\d{4}$/;
  const formatoMercosul = /^[A-Z]{3}-?\d[A-Z]\d{2}$/;
  const placaLimpa = placa.replace(/-/g, '').toUpperCase();
  return formatoAntigo.test(placaLimpa) || formatoMercosul.test(placaLimpa);
}

document.addEventListener('DOMContentLoaded', function(){
  carregarListasExistentes();
  setupAutocomplete('placa', 'placa-autocomplete', veiculos);
  restaurarEstadoTimers();
  
  const placaInput = document.getElementById('placa');
  if(placaInput){
    placaInput.addEventListener('input', function(e){
      this.value = this.value.toUpperCase();
      const erro = document.getElementById('placa-error');
      if(this.value.length >= 7){
        if(validarPlaca(this.value)){
          this.classList.remove('erro');
          if(erro) erro.style.display = 'none';
        } else {
          this.classList.add('erro');
          if(erro) erro.style.display = 'block';
        }
      } else {
        this.classList.remove('erro');
        if(erro) erro.style.display = 'none';
      }
    });
  }

  const searchInput = document.getElementById('search-input');
  if(searchInput){
    searchInput.addEventListener('input', function(e){
      termoBusca = this.value.toLowerCase();
      listar();
    });
  }
  
  iniciarAtualizacaoTempoReal();
});

function mostrarToast(mensagem, tipo = 'success'){
  const toast = document.createElement('div');
  toast.className = `toast ${tipo}`;
  const icon = tipo === 'success' ? '✓' : tipo === 'erro' ? '✗' : '⚠';
  toast.innerHTML = `<span style="font-size:24px">${icon}</span> ${mensagem}`;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-out';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function verificarOrdem(campoAtual){
  const indiceAtual = ordemEtapas.indexOf(campoAtual);
  for(let i = 0; i < indiceAtual; i++){
    const campoAnterior = ordemEtapas[i];
    const valor = document.getElementById(campoAnterior).value;
    if(!valor){
      mostrarToast(`Você precisa marcar "${getNomeEtapa(campoAnterior)}" antes!`, 'aviso');
      return false;
    }
  }
  return true;
}

function getNomeEtapa(campo){
  const nomes = {
    'entrada': 'Entrada',
    'checki': 'Checklist Inicial',
    'prep': 'Preparação',
    'amar': 'Amarração',
    'checkf': 'Checklist Final',
    'saida': 'Saída'
  };
  return nomes[campo] || campo;
}

function marcarTempo(campo){
  if(!verificarOrdem(campo)) return;

  if(campo === 'entrada' || campo === 'saida'){
    const agora = new Date();
    document.getElementById(campo).value = agora.toTimeString().slice(0,8);
    mostrarToast(`${getNomeEtapa(campo)} marcada com sucesso!`, 'success');
    return;
  }

  if(timers[campo]) return;

  const segundos = valorParaSegundos(campo);
  elapsedSeconds[campo] = segundos;
  startTimes[campo] = Date.now() - segundos * 1000;
  paused[campo] = false;

  iniciarTimer(campo);
  criarBotaoPausa(campo);
  salvarEstadoTimers();

  mostrarToast(`Timer de ${getNomeEtapa(campo)} iniciado!`, 'success');
}

function iniciarTimer(campo){
  function atualizar(){
    if(paused[campo]) return;
    
    const elapsed = Math.floor((Date.now() - startTimes[campo]) / 1000);
    elapsedSeconds[campo] = elapsed;
    
    const h = String(Math.floor(elapsed/3600)).padStart(2,'0');
    const m = String(Math.floor((elapsed%3600)/60)).padStart(2,'0');
    const s = String(elapsed%60).padStart(2,'0');
    const input = document.getElementById(campo);
    if(input) input.value = `${h}:${m}:${s}`;
  }
  
  atualizar();
  timers[campo] = setInterval(atualizar, 1000);
}

function pausarTempo(campo){
  if(!timers[campo] && !paused[campo]) return;
  
  if(paused[campo]){
    paused[campo] = false;
    startTimes[campo] = Date.now() - elapsedSeconds[campo] * 1000;
    if(!timers[campo]) iniciarTimer(campo);
    document.getElementById(`pause-${campo}`).innerHTML = '<i class="fas fa-pause"></i>';
    salvarEstadoTimers();
    mostrarToast('Timer retomado', 'success');
  } else {
    paused[campo] = true;
    document.getElementById(`pause-${campo}`).innerHTML = '<i class="fas fa-play"></i>';
    salvarEstadoTimers();
    mostrarToast('Timer pausado', 'aviso');
  }
}

function pararTodos(){
  Object.keys(timers).forEach(c=>{
    clearInterval(timers[c]);
    delete timers[c];
  });
  timers = {};
  startTimes = {};
  elapsedSeconds = {};
  paused = {};
  operacaoAtualId = null;
  localStorage.removeItem('g2l_timer_state');
}

function criarBotaoPausa(campo){
  if(document.getElementById(`pause-${campo}`)) return;
  const btn = document.createElement('button');
  btn.id = `pause-${campo}`;
  btn.innerHTML = '<i class="fas fa-pause"></i>';
  btn.className = 'btn btn-aviso btn-small';
  btn.style.marginLeft = '8px';
  btn.onclick = () => pausarTempo(campo);
  const input = document.getElementById(campo);
  if(input && input.parentElement) input.parentElement.appendChild(btn);
}

function calcularDuracao(entrada, saida){
  if(!entrada || !saida) return '-';
  const a = entrada.split(':').map(Number);
  const b = saida.split(':').map(Number);
  let s1 = a[0]*3600 + a[1]*60 + (a[2]||0);
  let s2 = b[0]*3600 + b[1]*60 + (b[2]||0);
  let diff = s2 - s1;
  if(diff < 0) diff += 86400;
  return `${Math.floor(diff/3600)}h ${Math.floor(diff%3600/60)}min ${diff%60}s`;
}

function calcularDuracaoSegundos(t1, t2){
  if(!t1 || !t2) return 0;
  const a = t1.split(':').map(Number);
  const b = t2.split(':').map(Number);
  let s1 = a[0]*3600 + a[1]*60 + (a[2] || 0);
  let s2 = b[0]*3600 + b[1]*60 + (b[2] || 0);
  let diff = s2 - s1;
  if(diff < 0) diff += 86400;
  return diff;
}

function verificarSLA(operacao){
  if(!operacao.entrada) return false;
  
  const slaLimite = 120;
  const agora = new Date();
  const horaEntrada = operacao.entrada.split(':');
  const entrada = new Date();
  entrada.setHours(parseInt(horaEntrada[0]), parseInt(horaEntrada[1]), parseInt(horaEntrada[2] || 0));
  
  const diffMinutos = Math.floor((agora - entrada) / 60000);
  
  return operacao.status === 'Em Andamento' && diffMinutos > slaLimite;
}

function salvar(){
  if(!placa.value){
    mostrarToast('Preencha Placa', 'erro');
    return;
  }
  
  if(!validarPlaca(placa.value)){
    mostrarToast('Formato de placa inválido!', 'erro');
    document.getElementById('placa').classList.add('erro');
    const erro = document.getElementById('placa-error');
    if(erro) erro.style.display = 'block';
    return;
  }
  
  if(!entrada.value){
    mostrarToast('Marque pelo menos o horário de Entrada!', 'erro');
    return;
  }

  const conferentesCheckboxes = document.querySelectorAll('input[name="conferente"]:checked');
  const conferentesSelecionados = Array.from(conferentesCheckboxes).map(cb => cb.value);

  const timerStartTimes = {};
  ['checki','prep','amar','checkf'].forEach(campo => {
    if(startTimes[campo]){
      timerStartTimes[campo] = startTimes[campo];
    }
  });

  const novaOperacao = {
    id: operacaoAtualId || Date.now(),
    dt: dt.value || '-',
    placa: placa.value.toUpperCase(),
    box: box.value || '-',
    tipoVeiculo: tipoVeiculo.value || '-',
    material: material.value || '-',
    configuracao: configuracao.value || '-',
    conferentes: conferentesSelecionados,
    entrada: entrada.value,
    checki: checki.value,
    prep: prep.value,
    amar: amar.value,
    checkf: checkf.value,
    saida: saida.value,
    timerStartTimes: timerStartTimes,
    timersPaused: {...paused},
    status: saida.value ? 'Concluída' : 'Em Andamento',
    data: new Date().toLocaleDateString('pt-BR'),
    dataHora: new Date().toISOString()
  };

  if(operacaoAtualId){
    dados = dados.filter(o => o.id !== operacaoAtualId);
  }

  dados.push(novaOperacao);
  
  if(!veiculos.includes(novaOperacao.placa)) {
    veiculos.push(novaOperacao.placa);
    localStorage.setItem('g2l_veiculos', JSON.stringify(veiculos));
  }

  localStorage.setItem('g2l', JSON.stringify(dados));
  backupFirebase(novaOperacao);
  
  operacaoAtualId = novaOperacao.id;
  salvarEstadoTimers();
  
  mostrarToast('✓ Operação salva! Timers continuam rodando.', 'success');
  
  dt.value = '';
  placa.value = '';
  box.value = '';
  tipoVeiculo.value = '';
  material.value = '';
  configuracao.value = '';
  document.querySelectorAll('input[name="conferente"]').forEach(cb => cb.checked = false);
  document.getElementById('placa').classList.remove('erro');
  const erro = document.getElementById('placa-error');
  if(erro) erro.style.display = 'none';
  
  listar();
}

function limparFormulario(){
  dt.value = '';
  placa.value = '';
  box.value = '';
  tipoVeiculo.value = '';
  material.value = '';
  configuracao.value = '';
  entrada.value = checki.value = prep.value = amar.value = checkf.value = saida.value = '';
  document.querySelectorAll('input[name="conferente"]').forEach(cb => cb.checked = false);
  document.getElementById('placa').classList.remove('erro');
  const erro = document.getElementById('placa-error');
  if(erro) erro.style.display = 'none';
  
  pararTodos();
  document.querySelectorAll('[id^="pause-"]').forEach(btn => btn.remove());
  mostrarToast('Formulário limpo e timers resetados', 'success');
}

function filtrarStatus(tipo){
  filtroAtual = tipo;
  document.querySelectorAll('.btn-filtro').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  listar();
}

function filtrarOperacoes(){
  let filtradas = dados;

  if(termoBusca){
    filtradas = filtradas.filter(o => 
      o.placa.toLowerCase().includes(termoBusca) ||
      (o.dt && o.dt.toLowerCase().includes(termoBusca)) ||
      o.data.includes(termoBusca)
    );
  }

  if(filtroAtual === 'concluida'){
    filtradas = filtradas.filter(o => o.status === 'Concluída');
  } else if(filtroAtual === 'andamento'){
    filtradas = filtradas.filter(o => o.status === 'Em Andamento');
  }

  return filtradas;
}

function mudarTab(id){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-conteudo').forEach(c=>c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(id).classList.add('active');
  if(id==='consulta')listar();
  if(id==='estatisticas')carregarEstatisticas();
}

function mudarTabProgramatico(id){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-conteudo').forEach(c=>c.classList.remove('active'));
  const buttons = document.querySelectorAll('.tab-btn');
  if(id === 'consulta'){
    buttons[1].classList.add('active');
  } else if(id === 'estatisticas'){
    buttons[2].classList.add('active');
  } else {
    buttons[0].classList.add('active');
  }
  document.getElementById(id).classList.add('active');
  if(id==='consulta')listar();
  if(id==='estatisticas')carregarEstatisticas();
}

function calcularTempoAtual(operacao){
  if(!operacao.entrada || operacao.saida) return null;
  
  let campoAtivo = null;
  let tempoAtual = 0;
  
  if(operacao.timerStartTimes){
    ['checkf','amar','prep','checki'].forEach(campo => {
      if(operacao.timerStartTimes[campo] && !campoAtivo){
        const estaPausado = operacao.timersPaused && operacao.timersPaused[campo];
        
        if(!estaPausado){
          campoAtivo = campo;
          tempoAtual = Math.floor((Date.now() - operacao.timerStartTimes[campo]) / 1000);
        } else {
          campoAtivo = campo;
          const valor = operacao[campo];
          if(valor){
            const partes = valor.split(':').map(Number);
            tempoAtual = (partes[0]||0)*3600 + (partes[1]||0)*60 + (partes[2]||0);
          }
        }
      }
    });
  }
  
  if(!campoAtivo){
    ['checkf','amar','prep','checki'].forEach(campo => {
      if(operacao[campo] && !campoAtivo){
        campoAtivo = campo;
        const partes = operacao[campo].split(':').map(Number);
        tempoAtual = (partes[0]||0)*3600 + (partes[1]||0)*60 + (partes[2]||0);
      }
    });
  }
  
  if(campoAtivo && tempoAtual > 0){
    const h = Math.floor(tempoAtual / 3600);
    const m = Math.floor((tempoAtual % 3600) / 60);
    const s = tempoAtual % 60;
    return `${h}h ${m}min ${s}s (${getNomeEtapa(campoAtivo)})`;
  }
  
  return null;
}

function iniciarAtualizacaoTempoReal(){
  if(updateInterval) clearInterval(updateInterval);
  
  updateInterval = setInterval(() => {
    const consultaTab = document.getElementById('consulta');
    if(consultaTab && consultaTab.classList.contains('active')){
      atualizarTemposEmAndamento();
    }
    
    if(operacaoAtualId && Object.keys(timers).length > 0){
      atualizarOperacaoEmAndamento();
    }
  }, 1000);
}

function atualizarOperacaoEmAndamento(){
  const opIndex = dados.findIndex(o => o.id === operacaoAtualId);
  
  if(opIndex !== -1){
    ['checki','prep','amar','checkf'].forEach(campo => {
      const input = document.getElementById(campo);
      if(input && input.value){
        dados[opIndex][campo] = input.value;
      }
    });
    
    const timerStartTimes = {};
    ['checki','prep','amar','checkf'].forEach(campo => {
      if(startTimes[campo]){
        timerStartTimes[campo] = startTimes[campo];
      }
    });
    dados[opIndex].timerStartTimes = timerStartTimes;
    dados[opIndex].timersPaused = {...paused};
    dados[opIndex].dataHora = new Date().toISOString();
    
    localStorage.setItem('g2l', JSON.stringify(dados));
  }
}

function atualizarTemposEmAndamento(){
  dados = JSON.parse(localStorage.getItem('g2l')||'[]');
  
  const operacoesAndamento = document.querySelectorAll('.cartao-operacao[data-em-andamento="true"]');
  
  operacoesAndamento.forEach(card => {
    const operacaoId = parseInt(card.dataset.operacaoId);
    const operacao = dados.find(o => o.id === operacaoId);
    
    if(operacao){
      const timeInfo = card.querySelector('.tempo-info');
      if(timeInfo){
        const tempoAtual = calcularTempoAtual(operacao);
        if(tempoAtual){
          timeInfo.innerHTML = `<span class="indicador-live"></span>Tempo decorrido: <strong>${tempoAtual}</strong>`;
        }
      }
    }
  });
}

function listar(){
  const container = document.getElementById('lista-operacoes');
  
  if(dados.length === 0){
    container.innerHTML = '<p style="text-align:center;color:#6c757d;padding:60px;font-size:16px;"><i class="fas fa-inbox" style="font-size:48px;display:block;margin-bottom:15px;opacity:0.3;"></i>Nenhuma operação registrada</p>';
    return;
  }

  const filtradas = filtrarOperacoes();

  if(filtradas.length === 0){
    container.innerHTML = '<p style="text-align:center;color:#6c757d;padding:60px;font-size:16px;"><i class="fas fa-search" style="font-size:48px;display:block;margin-bottom:15px;opacity:0.3;"></i>Nenhuma operação encontrada com os filtros aplicados</p>';
    return;
  }

  container.innerHTML = filtradas.slice().reverse().map(o => {
    const alertaSLA = verificarSLA(o);
    const conferentesTexto = o.conferentes && o.conferentes.length > 0 ? o.conferentes.join(', ') : '-';
    const emAndamento = o.status === 'Em Andamento';
    const tempoAtual = emAndamento ? calcularTempoAtual(o) : null;
    
    const tempoDisplay = emAndamento && tempoAtual ? 
      `<div class="tempo-info"><span class="indicador-live"></span>Tempo decorrido: <strong>${tempoAtual}</strong></div>` :
      (o.entrada && o.saida ? `<div class="tempo-info"><i class="fas fa-clock"></i> Tempo total: <strong>${calcularDuracao(o.entrada, o.saida)}</strong></div>` : '');
    
    return `
    <div class="cartao-operacao ${alertaSLA ? 'alerta-sla' : ''}" 
         data-operacao-id="${o.id}"
         data-em-andamento="${emAndamento}">
      <div class="cartao-header">
        <div>
          <div class="cartao-titulo">${o.dt !== '-' ? 'DT ' + o.dt : 'Placa ' + o.placa}</div>
          <div class="cartao-data"><i class="far fa-calendar-alt"></i> ${o.data}</div>
        </div>
        <div class="cartao-badges">
          <span class="badge ${o.status === 'Concluída' ? 'badge-concluido' : 'badge-andamento'}">
            <i class="fas ${o.status === 'Concluída' ? 'fa-check-circle' : 'fa-hourglass-half'}"></i>
            ${o.status}
          </span>
          ${alertaSLA ? '<span class="badge badge-sla"><i class="fas fa-exclamation-triangle"></i> SLA</span>' : ''}
        </div>
      </div>
      <div class="cartao-body">
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-hashtag"></i> DT</span>
          <span class="info-item-valor">${o.dt || '-'}</span>
        </div>
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-car"></i> Placa</span>
          <span class="info-item-valor">${o.placa}</span>
        </div>
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-warehouse"></i> Box</span>
          <span class="info-item-valor">${o.box || '-'}</span>
        </div>
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-truck"></i> Tipo Veículo</span>
          <span class="info-item-valor">${o.tipoVeiculo || '-'}</span>
        </div>
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-boxes"></i> Material</span>
          <span class="info-item-valor">${o.material || '-'}</span>
        </div>
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-cog"></i> Configuração</span>
          <span class="info-item-valor">${o.configuracao || '-'}</span>
        </div>
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-users"></i> Conferentes</span>
          <span class="info-item-valor">${conferentesTexto}</span>
        </div>
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-sign-in-alt"></i> Entrada</span>
          <span class="info-item-valor">${o.entrada || '-'}</span>
        </div>
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-clipboard-check"></i> Check Inicial</span>
          <span class="info-item-valor">${o.checki || '-'}</span>
        </div>
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-tools"></i> Preparação</span>
          <span class="info-item-valor">${o.prep || '-'}</span>
        </div>
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-link"></i> Amarração</span>
          <span class="info-item-valor">${o.amar || '-'}</span>
        </div>
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-clipboard-check"></i> Check Final</span>
          <span class="info-item-valor">${o.checkf || '-'}</span>
        </div>
        <div class="info-item">
          <span class="info-item-label"><i class="fas fa-sign-out-alt"></i> Saída</span>
          <span class="info-item-valor">${o.saida || '-'}</span>
        </div>
      </div>
      ${tempoDisplay}
      ${alertaSLA ? '<div class="tempo-info" style="background:#fff5f5;color:#dc3545;"><i class="fas fa-exclamation-triangle"></i> <strong>Operação ultrapassou o tempo limite de SLA!</strong></div>' : ''}
      <div class="cartao-acoes">
        <button class="btn btn-primario btn-small" onclick="editar(${o.id})">
          <i class="fas fa-edit"></i> Editar
        </button>
      </div>
    </div>
  `}).join('');
}

function editar(id){
  const op = dados.find(o => o.id === id);
  if(!op) return;
  
  if(operacaoAtualId === id && Object.keys(timers).length > 0){
    dt.value = op.dt === '-' ? '' : op.dt;
    placa.value = op.placa;
    box.value = op.box === '-' ? '' : op.box;
    tipoVeiculo.value = op.tipoVeiculo === '-' ? '' : op.tipoVeiculo;
    material.value = op.material === '-' ? '' : (op.material || '');
    configuracao.value = op.configuracao === '-' ? '' : op.configuracao;
    entrada.value = op.entrada || '';
    saida.value = op.saida || '';
    
    document.querySelectorAll('input[name="conferente"]').forEach(cb => {
      cb.checked = op.conferentes && op.conferentes.includes(cb.value);
    });
    
    dados = dados.filter(o => o.id !== id);
    localStorage.setItem('g2l', JSON.stringify(dados));
    mudarTabProgramatico('nova');
    mostrarToast('Voltando para edição - timers continuam rodando!', 'success');
    return;
  }
  
  Object.keys(timers).forEach(c => {
    clearInterval(timers[c]);
    delete timers[c];
  });
  document.querySelectorAll('[id^="pause-"]').forEach(btn => btn.remove());
  
  timers = {};
  startTimes = {};
  elapsedSeconds = {};
  paused = {};
  
  dt.value = op.dt === '-' ? '' : op.dt;
  placa.value = op.placa;
  box.value = op.box === '-' ? '' : op.box;
  tipoVeiculo.value = op.tipoVeiculo === '-' ? '' : (op.tipoVeiculo || '');
  material.value = op.material === '-' ? '' : (op.material || '');
  configuracao.value = op.configuracao === '-' ? '' : (op.configuracao || '');
  entrada.value = op.entrada || '';
  checki.value = op.checki || '';
  prep.value = op.prep || '';
  amar.value = op.amar || '';
  checkf.value = op.checkf || '';
  saida.value = op.saida || '';
  
  document.querySelectorAll('input[name="conferente"]').forEach(cb => {
    cb.checked = op.conferentes && op.conferentes.includes(cb.value);
  });
  
  ['checki','prep','amar','checkf'].forEach(c=>{
    const campo = document.getElementById(c);
    if(!campo) return;
    
    const valorCampo = op[c];
    
    if(op.timerStartTimes && op.timerStartTimes[c]){
      startTimes[c] = op.timerStartTimes[c];
      
      if(op.timersPaused && op.timersPaused[c]){
        paused[c] = true;
        if(valorCampo){
          const partes = valorCampo.split(':').map(Number);
          elapsedSeconds[c] = (partes[0]||0)*3600 + (partes[1]||0)*60 + (partes[2]||0);
        }
      } else {
        elapsedSeconds[c] = Math.floor((Date.now() - startTimes[c]) / 1000);
        paused[c] = false;
        iniciarTimer(c);
      }
      
      setTimeout(() => {
        criarBotaoPausa(c);
        if(paused[c]){
          const btn = document.getElementById(`pause-${c}`);
          if(btn) btn.innerHTML = '<i class="fas fa-play"></i>';
        }
      }, 100);
      
    } else if(valorCampo && op.entrada){
      const partes = valorCampo.split(':').map(Number);
      const segundos = (partes[0]||0)*3600 + (partes[1]||0)*60 + (partes[2]||0);
      elapsedSeconds[c] = segundos;
      
      if(!op.saida && segundos >= 0){
        startTimes[c] = Date.now() - segundos * 1000;
        paused[c] = false;
        iniciarTimer(c);
        
        setTimeout(() => {
          criarBotaoPausa(c);
        }, 100);
      }
    }
  });
  
  operacaoAtualId = id;
  salvarEstadoTimers();
  
  dados = dados.filter(o => o.id !== id);
  localStorage.setItem('g2l', JSON.stringify(dados));
  
  mudarTabProgramatico('nova');
  
  if(op.saida){
    mostrarToast('Operação concluída carregada para edição!', 'success');
  } else {
    mostrarToast('Operação retomada! Timers continuam de onde pararam.', 'success');
  }
}

function exportarCSV(){
  if(dados.length === 0){
    mostrarToast('Não há dados para exportar!', 'aviso');
    return;
  }
  let csv = 'Data,DT,Placa,BOX,Tipo de Veículo,Material,Configuração,Conferentes,Entrada,Checklist Inicial,Preparação,Amarração,Checklist Final,Saída,Status,Tempo Total\n';
  dados.forEach(o => {
    const tempo = o.entrada && o.saida ? calcularDuracao(o.entrada, o.saida) : '-';
    const conferentes = o.conferentes && o.conferentes.length > 0 ? o.conferentes.join('; ') : '-';
    csv+= `${o.data},"${o.dt || '-'}","${o.placa}","${o.box || '-'}","${o.tipoVeiculo || '-'}","${o.material || '-'}","${o.configuracao || '-'}","${conferentes}","${o.entrada || '-'}","${o.checki || '-'}","${o.prep || '-'}","${o.amar || '-'}","${o.checkf || '-'}","${o.saida || '-'}","${o.status}","${tempo}"\n`;
  });
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `g2l_operacoes_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  mostrarToast('CSV exportado com sucesso!', 'success');
}

function carregarEstatisticas(){
  if(dados.length === 0){
    document.getElementById('stats-content').innerHTML =
      '<p style="text-align:center;color:#6c757d;padding:60px;font-size:16px;"><i class="fas fa-chart-bar" style="font-size:48px;display:block;margin-bottom:15px;opacity:0.3;"></i>Nenhuma operação registrada</p>';
    return;
  }

  let total = dados.length;
  let concluidas = dados.filter(o => o.status === 'Concluída').length;
  let emAndamento = total - concluidas;

  let tempos = dados
    .filter(o => o.entrada && o.saida)
    .map(o => calcularDuracaoSegundos(o.entrada, o.saida));

  let media = tempos.length
    ? Math.floor(tempos.reduce((a,b)=>a+b,0) / tempos.length)
    : 0;

  function formatarSegundos(seg){
    const h = Math.floor(seg/3600);
    const m = Math.floor((seg%3600)/60);
    const s = seg%60;
    return `${h}h ${m}min ${s}s`;
  }

  document.getElementById('stats-content').innerHTML = `
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-titulo"><i class="fas fa-list-ol"></i> Total de Operações</div>
        <div class="stat-card-valor">${total}</div>
        <div class="stat-card-subtitulo">Registradas no sistema</div>
      </div>

      <div class="stat-card">
        <div class="stat-card-titulo"><i class="fas fa-check-circle"></i> Concluídas</div>
        <div class="stat-card-valor">${concluidas}</div>
        <div class="stat-card-subtitulo">Finalizadas com sucesso</div>
      </div>

      <div class="stat-card">
        <div class="stat-card-titulo"><i class="fas fa-hourglass-half"></i> Em Andamento</div>
        <div class="stat-card-valor">${emAndamento}</div>
        <div class="stat-card-subtitulo">Não finalizadas</div>
      </div>

      <div class="stat-card">
        <div class="stat-card-titulo"><i class="fas fa-clock"></i> Tempo Médio</div>
        <div class="stat-card-valor">${formatarSegundos(media)}</div>
        <div class="stat-card-subtitulo">Entrada → Saída</div>
      </div>
    </div>
  `;
}

listar();
</script>

<script>
let graficoLinhaSGQ = null;
let graficoDonutSGQ = null;

function criarDashboardCorporativo(){
  const estatisticas = document.getElementById('estatisticas');
  if(!estatisticas || document.getElementById('dash-sgq')) return;

  const bloco = document.createElement('div');
  bloco.id = 'dash-sgq';
  bloco.style.marginTop = '40px';

  bloco.innerHTML = `
    <h3 class="secao-titulo" style="margin-top:40px;">
      <i class="fas fa-chart-line"></i> Visão Gerencial
    </h3>

    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:30px">
      <div class="stat-card">
        <div class="stat-card-titulo">Total Operações</div>
        <div class="stat-card-valor" id="kpi-total">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-titulo">Média Diária</div>
        <div class="stat-card-valor" id="kpi-media">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-titulo">Melhor Dia</div>
        <div class="stat-card-valor" style="font-size:18px;" id="kpi-melhor">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-titulo">Pior Dia</div>
        <div class="stat-card-valor" style="font-size:18px;" id="kpi-pior">-</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:2fr 1fr;gap:25px">
      <div class="stat-card">
        <h4 style="margin-bottom:20px;color:var(--cor-primaria);font-weight:700;"><i class="fas fa-chart-area"></i> Tendência de Volume</h4>
        <canvas id="linha-sgq" height="120"></canvas>
      </div>

      <div class="stat-card">
        <h4 style="margin-bottom:20px;color:var(--cor-primaria);font-weight:700;"><i class="fas fa-chart-pie"></i> Distribuição</h4>
        <canvas id="donut-sgq" height="160"></canvas>
      </div>
    </div>
  `;

  estatisticas.appendChild(bloco);
}

function gerarDashboardCorporativo(){
  if(!document.getElementById('kpi-total')) return;
  if(!dados || dados.length === 0) return;

  const porDia = {};
  dados.forEach(d=>{
    porDia[d.data] = (porDia[d.data] || 0) + 1;
  });

  const dias = Object.keys(porDia);
  const valores = Object.values(porDia);

  document.getElementById('kpi-total').innerText = dados.length;
  document.getElementById('kpi-media').innerText =
    (dados.length / dias.length).toFixed(1);

  const max = Math.max(...valores);
  const min = Math.min(...valores);

  document.getElementById('kpi-melhor').innerText =
    dias[valores.indexOf(max)] + ` (${max})`;

  document.getElementById('kpi-pior').innerText =
    dias[valores.indexOf(min)] + ` (${min})`;

  const ctxL = document.getElementById('linha-sgq');
  const ctxD = document.getElementById('donut-sgq');

  if(!ctxL || !ctxD) return;

  if(graficoLinhaSGQ) graficoLinhaSGQ.destroy();
  if(graficoDonutSGQ) graficoDonutSGQ.destroy();

  graficoLinhaSGQ = new Chart(ctxL,{
    type:'line',
    data:{
      labels:dias,
      datasets:[{
        label:'Operações',
        data:valores,
        tension:0.3,
        fill:true,
        backgroundColor: 'rgba(0, 148, 58, 0.1)',
        borderColor: '#00943A',
        pointBackgroundColor: '#00943A',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: '#00943A'
      }]
    },
    options:{
      responsive: true,
      maintainAspectRatio: true,
      plugins:{ 
        legend:{display:false},
        tooltip: {
          backgroundColor: 'rgba(0, 148, 58, 0.9)',
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 },
          padding: 12,
          cornerRadius: 8
        }
      },
      scales:{ 
        y:{ 
          beginAtZero:true,
          ticks: {
            font: { family: 'Montserrat' }
          }
        },
        x: {
          ticks: {
            font: { family: 'Montserrat' }
          }
        }
      }
    }
  });

  graficoDonutSGQ = new Chart(ctxD,{
    type:'doughnut',
    data:{
      labels:dias,
      datasets:[{ 
        data:valores,
        backgroundColor: [
          '#00943A',
          '#006428',
          '#28a745',
          '#20c997',
          '#17a2b8',
          '#007bff'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options:{
      responsive: true,
      maintainAspectRatio: true,
      plugins:{ 
        legend:{ 
          position:'bottom',
          labels: {
            font: { 
              family: 'Montserrat',
              size: 11
            },
            padding: 15,
            usePointStyle: true
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 148, 58, 0.9)',
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 },
          padding: 12,
          cornerRadius: 8
        }
      }
    }
  });
}

const _oldCarregarEstatisticas3 = carregarEstatisticas;
carregarEstatisticas = function(){
  _oldCarregarEstatisticas3();
  criarDashboardCorporativo();
  gerarDashboardCorporativo();
};
</script>

</body>
</html>
